    <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> n&#43;1 Problems and Identity Maps &middot; { always: &#39;coding&#39; } </title>
    
    <link rel="stylesheet" type="text/css" href="https://brianp.github.io//css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="https://brianp.github.io//css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://brianp.github.io/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://brianp.github.io/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="{ always: &#39;coding&#39; }" />
    
    <script src="https://brianp.github.io//js/jquery.min.js"></script>
    <script src="https://brianp.github.io//js/main.min.js">
    </script>
</head>

    <body>
        <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/side-column-bg.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="https://brianp.github.io//" title="link to homepage for { always: &#39;coding&#39; }"> <img src="http://www.gravatar.com/avatar/c15ec5b29cc5407a01bd17907e41230b?s=160" width="80" alt="{ always: &#39;coding&#39; } logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="https://brianp.github.io//"  title="link to homepage for { always: &#39;coding&#39; }">{ always: &#39;coding&#39; }</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  Brian Pearce  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="https://brianp.github.io/#blog" title="link to { always: &#39;coding&#39; } blog" class="blog-button">Blog</a> </li>
                            <li class="navigation__item"><a href="https://brianp.github.io/posts" title="The blog archive" class="blog-button">Archive</a> </li></br>
                            
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/brian_pearce" title="@brian_pearce on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="http://no.linkedin.com/in/brian-pearce/en" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/brianp" title="brianp on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  </ul>
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/side-column-bg.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="https://brianp.github.io//" title="link to homepage for { always: &#39;coding&#39; }"> <img src="http://www.gravatar.com/avatar/c15ec5b29cc5407a01bd17907e41230b?s=160" width="80" alt="{ always: &#39;coding&#39; } logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="https://brianp.github.io//"  title="link to homepage for { always: &#39;coding&#39; }">{ always: &#39;coding&#39; }</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  Brian Pearce  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="https://brianp.github.io//#blog" title="link to { always: &#39;coding&#39; } blog" class="blog-button">Blog</a> </li></br>
                                
                                
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/brian_pearce" title="@brian_pearce on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="http://no.linkedin.com/in/brian-pearce/en" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/brianp" title="brianp on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

        <div class="content-wrapper">
            <div class="content-wrapper__inner">
                <div class="post">
                    <h1>n&#43;1 Problems and Identity Maps</h1>
                    <span class="post-date">Wed, Mar 6, 2013</span>
                    

<p>Forward: This post is mainly copypasta from an answer I wrote on StackOverflow. It also takes into account the version of Mongoid being used predates the <code>includes</code> method. The <code>includes</code> method being the suggested best practice for the problem now. <code>includes</code> will be mentioned at the bottom of the post.</p>

<p><a href="#current">Take me to the current best practice</a>.</p>

<p>How to deal with n+1 issues utilizing identity maps:</p>

<h3 id="what-is-the-n-1-issue">What is the n+1 issue?</h3>

<p>The n plus 1 issue occurs when you reference an associated record while looping an array of records. For example (using sql): You load a list of <code>Posts</code> and loop those posts displaying the <code>User</code> who created each post. The initial posts would require a single query <code>SELECT * FROM 'posts'</code>.  Then when you loop the posts to display the user using <code>post.user</code>. The db will be queried again. <code>SELECT * FROM 'users' WHERE 'user_id' = post.user_id</code>. This query will happen once for every post you loop. If you have 10 posts you will get 10 extra queries for the users who wrote those posts. This is the definition of the n+1 issue.</p>

<h3 id="avoiding-unnecessary-queries">Avoiding unnecessary queries</h3>

<p>In my case it was an n+2 issue.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Judge</span>
  <span style="color: #003388; font-weight: bold">include</span> <span style="color: #003366; font-weight: bold">Mongoid</span><span style="color: #333333">::</span><span style="color: #003366; font-weight: bold">Document</span>
  belongs_to <span style="color: #AA6600">:user</span>
  belongs_to <span style="color: #AA6600">:photo</span>

  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">as_json</span>(options<span style="color: #333333">=</span>{})
    {
      <span style="color: #007020">id</span>: _id,
      <span style="color: #AA6600">photo</span>: photo,
      <span style="color: #AA6600">user</span>: user
    }
  <span style="color: #008800; font-weight: bold">end</span>
<span style="color: #008800; font-weight: bold">end</span>

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">User</span>
  <span style="color: #003388; font-weight: bold">include</span> <span style="color: #003366; font-weight: bold">Mongoid</span><span style="color: #333333">::</span><span style="color: #003366; font-weight: bold">Document</span>
  has_one <span style="color: #AA6600">:judge</span>
<span style="color: #008800; font-weight: bold">end</span>

<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Photo</span>
  <span style="color: #003388; font-weight: bold">include</span> <span style="color: #003366; font-weight: bold">Mongoid</span><span style="color: #333333">::</span><span style="color: #003366; font-weight: bold">Document</span>
  has_one <span style="color: #AA6600">:judge</span>
<span style="color: #008800; font-weight: bold">end</span>

<span style="color: #888888"># judges_controller</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">index</span>
  <span style="color: #3333BB">@judges</span> <span style="color: #333333">=</span> <span style="color: #003366; font-weight: bold">Judge</span><span style="color: #333333">.</span>all
  respond_with <span style="color: #3333BB">@judges</span>
<span style="color: #008800; font-weight: bold">end</span>
</pre></div>

<p>This as_json response results in an n+2 query issue from the Judge record. in my case giving the dev server a response time of:</p>

<p><code>Completed 200 OK in 816ms (Views: 785.2ms)</code></p>

<p>The key to solving this issue is to load the <code>Users</code> and the <code>Photos</code> in a single query instead of 1 by 1 per <code>Judge</code>.</p>

<p>You can do this utilizing Mongoids IdentityMap. Mongoid 2 and Mongoid 3 support this feature.</p>

<p>First turn on the identity map in the mongoid.yml configuration file:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>development:
  host: localhost
  database: awesome_app
  identity_map_enabled: true
</pre></div>

<p>Now change the controller action to manually load the users and photos. Note: The Mongoid::Relation record will lazily evaluate the query so you must call to_a to actually query the records and have them stored in the IdentityMap.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">index</span>
  <span style="color: #3333BB">@judges</span> <span style="color: #333333">=</span> <span style="color: #003366; font-weight: bold">Judge</span><span style="color: #333333">.</span>all
  <span style="color: #3333BB">@users</span> <span style="color: #333333">=</span> <span style="color: #003366; font-weight: bold">User</span><span style="color: #333333">.</span>where(<span style="color: #AA6600">:_id</span><span style="color: #333333">.</span>in <span style="color: #333333">=&gt;</span> <span style="color: #3333BB">@judges</span><span style="color: #333333">.</span>map(<span style="color: #333333">&amp;</span><span style="color: #AA6600">:user_id</span>))<span style="color: #333333">.</span>to_a
  <span style="color: #3333BB">@photos</span> <span style="color: #333333">=</span> <span style="color: #003366; font-weight: bold">Photo</span><span style="color: #333333">.</span>where(<span style="color: #AA6600">:_id</span><span style="color: #333333">.</span>in <span style="color: #333333">=&gt;</span> <span style="color: #3333BB">@judges</span><span style="color: #333333">.</span>map(<span style="color: #333333">&amp;</span><span style="color: #AA6600">:photo_id</span>))<span style="color: #333333">.</span>to_a
  respond_with <span style="color: #3333BB">@judges</span>
<span style="color: #008800; font-weight: bold">end</span>
</pre></div>

<p>This results in only 3 queries total. 1 for the <code>Judges</code>, 1 for the <code>Users</code> and 1 for the <code>Photos</code>.</p>

<p><code>Completed 200 OK in 559ms (Views: 87.7ms)</code></p>

<h3 id="how-does-this-work-what-s-an-identitymap">How does this work? What&rsquo;s an IdentityMap?</h3>

<p>An IdentityMap helps to keep track of what objects or records have already been loaded. So if you fetch the first <code>User</code> record the IdentityMap will store it. Then if you attempt to fetch the same <code>User</code> again Mongoid queries the IdentityMap for the User before it queries the Database again. This will save 1 query on the database.</p>

<p>By fetching all of the <code>User</code> and <code>Photo</code> records that the <code>Judges</code> require in manual queries we load the data into the IdentityMap for later use. Then when the Judge requires it&rsquo;s <code>User</code> and <code>Photo</code> it checks the IdentityMap and does not need to query the database for them.</p>

<p><a name='current'></a></p>

<h3 id="the-includes-method">The includes method</h3>

<p>Following the practice from ActiveRecord, Mongoid later included a method for doing this type of call in a single concise method.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #003366; font-weight: bold">Judge</span><span style="color: #333333">.</span>all<span style="color: #333333">.</span>includes(<span style="color: #AA6600">:user</span>, <span style="color: #AA6600">:photo</span>)
</pre></div>

<p>This will perform only 3 queries selecting only the users and photos that belong to the returned judges.</p>

<p>Here are links to the docs for both Mongoid and ActiveRecord:<br />
<a href="http://mongoid.org/en/mongoid/docs/querying.html#query_plus">Read more about eager loading in
Mongoid</a>.<br />
<a href="http://guides.rubyonrails.org/active_record_querying.html#eager-loading-associations">Read more about eager loading in
ActiveRecord</a>.</p>

                </div>
            </div>
        </div>
    </body>
    
</html>
